
#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>

// .......FAN VARIABLES.......
int motor1pin1 = 2;
int motor1pin2 = 3;
int motor2pin1 = 4;
int motor2pin2 = 5;

int pwmPin1 = 9;  // PWM for Motor 1
int pwmPin2 = 11; // PWM for Motor 2


// ..........ICON ARRAYS.......

// temp icon
const unsigned char epd_bitmap_temp_icon [] PROGMEM = {
  0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x73, 0x80, 0x00, 0x00, 0x00, 0x00, 0x61, 0x80, 
  0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 
  0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0xf0, 
  0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 
  0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 
  0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 
  0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x5e, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 
  0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 
  0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5e, 0xf0, 0x00, 0x00, 
  0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 
  0x00, 0x00, 0x00, 0x00, 0x5e, 0x80, 0x00, 0x00, 0x00, 0x00, 0xde, 0xc0, 0x00, 0x00, 0x00, 0x01, 
  0x9e, 0x60, 0x00, 0x00, 0x00, 0x03, 0x7f, 0xb0, 0x00, 0x00, 0x00, 0x06, 0xff, 0xd8, 0x00, 0x00, 
  0x00, 0x05, 0xff, 0xe8, 0x00, 0x00, 0x00, 0x0d, 0xff, 0xec, 0x00, 0x00, 0x00, 0x0d, 0xff, 0xec, 
  0x00, 0x00, 0x00, 0x0d, 0xff, 0xec, 0x00, 0x00, 0x00, 0x0d, 0xff, 0xec, 0x00, 0x00, 0x00, 0x06, 
  0xff, 0xd8, 0x00, 0x00, 0x00, 0x06, 0x7f, 0x98, 0x00, 0x00, 0x00, 0x03, 0x9e, 0x70, 0x00, 0x00, 
  0x00, 0x00, 0xe1, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00
};
// 'dust_icon', 42x50px
const unsigned char epd_bitmap_dust_icon [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x10, 0xc0, 0x00, 0x00, 
  0x00, 0x00, 0x30, 0x40, 0x00, 0x00, 0x00, 0x00, 0x20, 0x41, 0x80, 0x00, 0x00, 0x44, 0x04, 0x46, 
  0x60, 0x00, 0x00, 0x00, 0x00, 0x48, 0x20, 0x00, 0x00, 0x00, 0x01, 0x88, 0x10, 0x00, 0x03, 0xff, 
  0xff, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x01, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 
  0x00, 0x1f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x0f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xc2, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x01, 0x00, 0x10, 0x00, 0x00, 
  0x00, 0x10, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x08, 0x30, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x20, 
  0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'humidity_icon', 42x50px
const unsigned char epd_bitmap_humidity_icon [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd8, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x8c, 0x00, 0x00, 0x00, 0x00, 0x03, 0x06, 0x00, 0x00, 0x00, 0x00, 0x06, 0x03, 0x00, 0x00, 0x00, 
  0x00, 0x0c, 0x01, 0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x80, 0x00, 0x00, 0x00, 0x18, 0x00, 0xc0, 
  0x00, 0x00, 0x00, 0x30, 0x00, 0x40, 0x00, 0x00, 0x00, 0x20, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 
  0x00, 0x20, 0x00, 0x00, 0x00, 0x40, 0x00, 0x30, 0x00, 0x00, 0x00, 0x40, 0x00, 0x10, 0x00, 0x00, 
  0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x40, 0x00, 0x00, 0x00, 0x88, 0x00, 0xe0, 
  0x80, 0x00, 0x00, 0x88, 0x01, 0x90, 0x80, 0x00, 0x00, 0x88, 0x01, 0x11, 0x80, 0x00, 0x00, 0x8c, 
  0x01, 0x13, 0x00, 0x00, 0x00, 0xc4, 0x01, 0x12, 0x00, 0x00, 0x00, 0x43, 0x01, 0xb6, 0x60, 0x00, 
  0x00, 0x61, 0xc0, 0xe4, 0xf0, 0x00, 0x00, 0x30, 0x00, 0x09, 0x10, 0x00, 0x00, 0x18, 0x00, 0x09, 
  0x18, 0x00, 0x00, 0x0e, 0x03, 0x11, 0x18, 0x00, 0x00, 0x03, 0xfe, 0x31, 0x10, 0x00, 0x00, 0x00, 
  0x70, 0x20, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'CO_icon', 42x50px
const unsigned char epd_bitmap_CO_icon [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x1f, 
  0xff, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0x00, 0x00, 
  0x00, 0x7f, 0xff, 0xff, 0x80, 0x00, 0x03, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x0f, 0xff, 0xff, 0xff, 
  0xc0, 0x00, 0x1f, 0xf8, 0x7e, 0x1f, 0xe0, 0x00, 0x3f, 0xf0, 0x38, 0x0f, 0xe0, 0x00, 0x3f, 0xe7, 
  0x19, 0xe7, 0xf8, 0x00, 0x7f, 0xe7, 0xf3, 0xe7, 0xfc, 0x00, 0x7f, 0xcf, 0xf3, 0xe7, 0xfc, 0x00, 
  0x7f, 0xcf, 0xf3, 0xe3, 0xfe, 0x00, 0x7f, 0xc7, 0xf3, 0xe7, 0xfe, 0x00, 0x7f, 0xe7, 0x91, 0xe7, 
  0xfe, 0x00, 0x3f, 0xe2, 0x38, 0x87, 0xfe, 0x00, 0x3f, 0xf0, 0x7c, 0x0f, 0xfe, 0x00, 0x1f, 0xff, 
  0xff, 0xff, 0xfc, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x01, 0xff, 0xff, 0xff, 0xf8, 0x00, 
  0x00, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x3f, 0xff, 0xff, 
  0x00, 0x00, 0x00, 0x1f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x07, 0xf9, 0xfc, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'CO2_icon', 42x50px
const unsigned char epd_bitmap_CO2_icon [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 
  0x1f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xfc, 0x00, 0x00, 
  0x00, 0x3c, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 
  0x00, 0x00, 0x01, 0xfe, 0x3c, 0x7f, 0x00, 0x00, 0x01, 0xfc, 0x18, 0x3f, 0xe0, 0x00, 0x01, 0xf9, 
  0xd9, 0x9f, 0xf8, 0x00, 0x07, 0xfb, 0xc3, 0xdf, 0xfc, 0x00, 0x0f, 0xfb, 0xf3, 0xdf, 0xfe, 0x00, 
  0x1f, 0xfb, 0xf3, 0xdf, 0xfe, 0x00, 0x1f, 0xfb, 0xf3, 0xdc, 0xff, 0x00, 0x3f, 0xfb, 0xd3, 0xd8, 
  0x7f, 0x00, 0x3f, 0xfb, 0xc3, 0xda, 0x7f, 0x00, 0x3f, 0xf9, 0x99, 0x9e, 0x7f, 0x00, 0x3f, 0xfc, 
  0x18, 0x3c, 0xff, 0x00, 0x1f, 0xfe, 0x7e, 0x78, 0xfe, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x7c, 0x00, 
  0x0f, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x03, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// ......GAS VARIABLES.......
#define MQ9_PIN A0    // Analog pin connected to MQ-9
#define RL_VALUE 10.0 // Load resistor value in kilo-ohms
#define RO_CLEAN_AIR 9.6 // Ro in clean air (estimated from datasheet)

// .......CO2 VARIABLES........
int co2Pin = A2;

// .......OLED SETTINGS........
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C 
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// ........DHT SENSOR SETTINGS.....
#define DHTPIN 0     
#define DHTTYPE DHT22   
DHT dht(DHTPIN, DHTTYPE);

// Variables for sensor readings
float hum;  
float temp; 

/* varialble for gas sensor
float getGasConcentration(float ratio, float a, float b) {
    return pow(10, (log10(ratio) - a) / b);
}*/

// .......DUST SENSOR VARIABLES.....

const int dustSensorPin = A1;   // Analog pin connected to sensor output (Vo)
const int ledControlPin = 7;    // Digital pin to control the LED inside the sensor

//.....GAS SENSOR VARIABLES.......

float coPPM;
float ch4PPM;
float lpgPPM;

// Constants for timing
const int samplingTime = 280;   // Time to sample sensor data (in microseconds)
const int deltaTime = 40;       // Small delay before reading data
const int sleepTime = 9680; 
    // Time to turn off LED (energy saving)
float gasSensorValue = 0;
float voltage = 0;
float dustDensity = 0;


void setup() {
    Serial.begin(9600);
    // ........FAN PINS......
    pinMode(pwmPin1, OUTPUT);
    pinMode(motor1pin1, OUTPUT);
    pinMode(motor1pin2, OUTPUT);

    pinMode(pwmPin2, OUTPUT);
    pinMode(motor2pin1, OUTPUT);
    pinMode(motor2pin2, OUTPUT);
    // ....DUST PIN...
    pinMode(ledControlPin, OUTPUT);

    // Initialize OLED display
    if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
        Serial.println(F("SSD1306 allocation failed"));
        for (;;); // Stop execution if OLED fails
    }

    // Initialize DHT sensor
    dht.begin();
    
    // Startup message on OLED
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(WHITE);
    display.setCursor(0, 0);
    display.print("DHT22 Sensor Init...");
    display.display();
   
}
void loop() {

    // .......TEMPERATURE SENSOR......
    hum = dht.readHumidity();
    temp = dht.readTemperature();

    // ......OLED......
    display.clearDisplay();
    // Check if readings are valid
    if (isnan(hum)  isnan(temp)) {
        Serial.println("Failed to read from DHT sensor!");
        display.setCursor(0, 10);
        display.print("Sensor Error!");
        display.display();
        delay(2000);
        return;
    }

    // .........CO2 SENSOR.....

    int co2SensorValue = analogRead(co2Pin); // Read the analog value
  float voltage = co2SensorValue * (5.0 / 1023.0); // Convert to voltage (assuming 5V reference)

  // Map voltage to CO₂ concentration (in ppm)
  // Note: This mapping is an example and requires calibration for accurate results
  int co2Level = map(voltage * 100, 0, 500, 350, 10000); // Adjust based on calibration


// ...........DUST SENSOR........

    digitalWrite(ledControlPin, LOW);   // Turn on LED inside the sensor
    delayMicroseconds(samplingTime);    // Wait for stable output

    float dustSensorValue = analogRead(dustSensorPin);  // Read analog voltage from sensor
    delayMicroseconds(deltaTime);                 // Small delay

    digitalWrite(ledControlPin, HIGH);  // Turn off LED (reduce power usage)
    delayMicroseconds(sleepTime);       // Allow sensor to reset
    voltage = dustSensorValue * (5.0 / 1024.0); // Convert raw sensor reading to voltage
    dustDensity = ((0.16 * voltage) - 0.1)*1000;// Convert voltage to dust concentration (approximate formula from datasheet)


    // ......FAN SPEED CONTROL......
int motorspeed = 0;

    if (temp > 35  dustDensity > 700  co2Level > 600  coPPM > 500) {
        motorspeed = 255; // Max Speed (100%)
    } 
    else if (temp > 30  dustDensity > 500  co2Level > 400  coPPM > 350) {
        motorspeed = 180; // Medium Speed (70%)
    } 
    else if (temp > 25  dustDensity > 300  co2Level > 200  coPPM > 200) {
        motorspeed = 100; // Low Speed (40%)
    } 
    else {
        stopFan();
        return; // Exit loop to stop motors completely
    }
    // Run both motors forward
    digitalWrite(motor1pin1, HIGH);
    digitalWrite(motor1pin2, LOW);
    analogWrite(pwmPin1, motorspeed);

    digitalWrite(motor2pin1, HIGH);
    digitalWrite(motor2pin2, LOW);
    analogWrite(pwmPin2, motorspeed);

    delay(2000);

    // Reverse motors after delay
    digitalWrite(motor1pin1, LOW);
    digitalWrite(motor1pin2, HIGH);
    digitalWrite(motor2pin1, LOW);
    digitalWrite(motor2pin2, HIGH);


    //......SERIAL MONITOR......

    // dust sensor
    Serial.print("Raw Value: ");
    Serial.print(dustSensorValue);
    Serial.print(" | Voltage: ");
    Serial.print(voltage);
    Serial.print("V | Dust Density: ");
    Serial.print(dustDensity);
    Serial.println(" µg/m³");
   //tem and hum
    Serial.print("Humidity: ");
    Serial.print(hum);
    Serial.print(" % | Temperature: ");
    Serial.print(temp);
    Serial.println(" C");
// gas sensor
    Serial.print("CO: ");
    Serial.print(coPPM);
    Serial.print(" ppm | CH4: ");
// co2 sensor
    Serial.print("Voltage: ");
    Serial.print(voltage);
    Serial.print(" V | CO₂ Level: ");
    Serial.print(co2Level);
    Serial.println(" ppm");

// .......DISPLAY DATA ON OLED.......
    display.clearDisplay();// Clear the screen
    drawTemperatureScreen(temp); 
    display.display();
    delay(3000);
    drawHumidityScreen(hum);
    display.display();
    delay(3000);
    drawDustScreen(dustDensity);
    display.display();
    delay(3000);
    drawCaDiOxideScreen(co2Level); 
    display.display();
    delay(3000);
    drawCaMonOxideScreen(coPPM); 
    display.display();
    delay(3000);
    
}

//........GAS SENSOR FUNCTIONS.........

float getCOPPM(float ratio) {
    return pow(10, ((log10(ratio) - 0.32) / -0.85)); // Adjusted for MQ-9 CO curve
}
// Function to calibrate sensor Ro in clean air
float calibrateMQ9() {
    float sum = 0;
    int samples = 100;
    for (int i = 0; i < samples; i++) {
        int rawValue = analogRead(MQ9_PIN);
        float voltage = (rawValue / 1023.0) * 5.0;
        float resistance = ((5.0 - voltage) / voltage) * RL_VALUE;
        sum += resistance;
        delay(10);
    }
    return sum / samples / 9.6;  // Adjust Ro based on clean air measurement
}

void readCO() {
    int rawValue = analogRead(MQ9_PIN);
    float sensorVoltage = (rawValue / 1023.0) * 5.0;
    float sensorResistance = ((5.0 - sensorVoltage) / sensorVoltage) * RL_VALUE;
    float ratio = sensorResistance / RO_CLEAN_AIR; // Use calibrated Ro

    // Calculate CO concentration
    float coPPM = getCOPPM(ratio);

    // Prevent negative values
    if (coPPM < 0) coPPM = 0;

    // Print CO values
    Serial.print("CO: ");
    Serial.print(coPPM);
    Serial.println(" ppm");
}

//....... FAN FUNCTION......

void stopFan() {
    digitalWrite(motor1pin1, LOW);
    digitalWrite(motor1pin2, LOW);
    analogWrite(pwmPin1, 0);

    digitalWrite(motor2pin1, LOW);
    digitalWrite(motor2pin2, LOW);
    analogWrite(pwmPin2, 0);

    Serial.println("Fan stopped.");
}
//........DESPLAY FUNCTIONS........

void drawTemperatureScreen(int temperature) {

  display.clearDisplay();
  // 'temp icon', 128x64px
display.drawBitmap(82, 0, epd_bitmap_temp_icon, 42, 50, WHITE);

    // Display "Temperature" text
    display.setTextSize(1);  // Small text for the label
    display.setCursor(35, 54);
    display.print("Temperature");

    // Display Large Temperature Value
    display.setTextSize(3); // Large text for temperature
    display.setCursor(10, 10); // Positioning
    display.print(temperature);

    display.setTextSize(1); 
    //display.setCursor(50, 10); // Positioning
    display.cp437(true);
    display.write(167);
    display.print("C");

    display.display();  // Show the output
}
void drawHumidityScreen(int humidity) {

  display.clearDisplay();
  // 'temp icon', 128x64px
display.drawBitmap(82, 0, epd_bitmap_humidity_icon, 42, 50, WHITE);

    // Display "Temperature" text
    display.setTextSize(1);  // Small text for the label
    display.setCursor(35, 54);
    display.print("Humidity");

    // Display Large Temperature Value
    display.setTextSize(3); // Large text for temperature
    display.setCursor(10, 10); // Positioning
    display.print(humidity);

    display.setTextSize(1); 
    display.cp437(true);
    display.write(37);
    

    display.display();  // Show the output
}

void drawDustScreen(int dust){

  display.clearDisplay();
  // 'temp icon', 128x64px
  display.drawBitmap(82, 0, epd_bitmap_dust_icon, 42, 50, WHITE);

    // Display "Temperature" text
    display.setTextSize(1);  // Small text for the label
    display.setCursor(0, 54);
    display.print("Particulate Matter");
    // Display Large Temperature Value
    display.setTextSize(3); // Large text for temperature
    display.setCursor(10, 10); // Positioning
    display.print(dust);

    display.setTextSize(1); 
    display.print("µg/m³");

}
void drawCaDiOxideScreen(int co2){

  display.clearDisplay();
  // 'temp icon', 128x64px
  display.drawBitmap(82, 0, epd_bitmap_CO2_icon, 42, 50, WHITE);

    // Display "Temperature" text
    display.setTextSize(1);  // Small text for the label
    display.setCursor(35, 54);
    display.print("CO2");
    // Display Large Temperature Value
    display.setTextSize(3); // Large text for temperature
    display.setCursor(10, 10); // Positioning
    display.print(co2);
    display.setTextSize(1); 
    display.print("ppm");

}
void drawCaMonOxideScreen(int co){

  display.clearDisplay();
  // 'temp icon', 128x64px
  display.drawBitmap(82, 0, epd_bitmap_CO_icon, 42, 50, WHITE);
// Display "Temperature" text
    display.setTextSize(1);  // Small text for the label
    display.setCursor(35, 54);
    display.print("CO");
    // Display Large Temperature Value
    display.setTextSize(3); // Large text for temperature
    display.setCursor(10, 10); // Positioning
    display.print(co);
    display.setTextSize(1); 
    display.print("ppm");

}
